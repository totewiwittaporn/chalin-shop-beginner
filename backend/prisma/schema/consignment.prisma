// prisma/schema/consignment.prisma

model ConsignmentPartner {
  id     Int           @id @default(autoincrement())
  code   String        @unique
  name   String
  status PartnerStatus @default(ACTIVE)

  // ตั้งชื่อ relation ชัดเจน
  shops       ConsignmentCategory[]    @relation("PartnerCategories")
  maps        ConsignmentCategoryMap[]
  inventories ConsignmentInventory[]
  documents   Document[]
  users       User[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  StockLedger StockLedger[]
  StockCount  StockCount[]
  Transfer    Transfer[]
}

model ConsignmentCategory {
  id        Int @id @default(autoincrement())
  partnerId Int

  /// รหัสหมวด (เช่น SNK, BAG-CL, etc.)
  code String
  /// ชื่อหมวด (แสดงผล)
  name String

  // ใส่ชื่อ relation ให้ "ตรงกัน" กับฝั่ง ConsignmentPartner
  partner ConsignmentPartner @relation("PartnerCategories", fields: [partnerId], references: [id], onDelete: Cascade)

  // ใส่ชื่อ relation ให้ตรงกับคู่ใน ConsignmentCategoryMap
  maps ConsignmentCategoryMap[] @relation("CategoryMaps")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// ไม่ให้ code ซ้ำในร้านเดียวกัน
  @@unique([partnerId, code])
  @@index([partnerId])
}

model ConsignmentCategoryMap {
  id Int @id @default(autoincrement())

  partnerId  Int
  categoryId Int
  productId  Int

  partner ConsignmentPartner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  // ตั้งชื่อ relation ฝั่งนี้ให้ตรงกับ ConsignmentCategory.maps
  category ConsignmentCategory @relation("CategoryMaps", fields: [categoryId], references: [id], onDelete: Cascade)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([partnerId, productId])
  @@index([categoryId])
  @@index([productId])
}

model ConsignmentInventory {
  id Int @id @default(autoincrement())

  partnerId Int
  productId Int
  qtyOnHand Decimal @default(0) @db.Decimal(12, 2)
  price     Decimal @db.Decimal(12, 2)

  partner ConsignmentPartner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  product Product            @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([partnerId, productId])
  @@index([productId])
}
