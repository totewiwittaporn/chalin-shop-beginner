generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

enum Role {
  ADMIN
  STAFF
  CONSIGNMENT
  QUOTE_VIEWER
}

model User {
  id       Int     @id @default(autoincrement())
  email    String  @unique
  password String
  name     String
  role     Role    @default(QUOTE_VIEWER)
  branchId Int?
  branch   Branch? @relation(fields: [branchId], references: [id])

  // üîÅ back-relations (‡πÉ‡∏´‡∏°‡πà)
  transfersCreated       Transfer[]       @relation("TransferCreatedBy")
  consignReceiptsCreated ConsignReceipt[] @relation("ConsignReceiptCreatedBy")
  consignReturnsCreated  ConsignReturn[]  @relation("ConsignReturnCreatedBy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Branch {
  id                Int     @id @default(autoincrement())
  code              String  @unique
  name              String
  address           String?
  commissionPercent Float?

  users User[]

  // üîÅ back-relations (‡πÉ‡∏´‡∏°‡πà)
  transfersFrom    Transfer[]      @relation("TransfersFromBranch")
  consignReturnsIn ConsignReturn[] @relation("ReturnsToBranch")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductType {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id            Int         @id @default(autoincrement())
  sku           String      @unique
  name          String
  basePrice     Decimal     @db.Decimal(10, 2)
  productTypeId Int
  productType   ProductType @relation(fields: [productTypeId], references: [id])

  // üîÅ back-relations (‡πÉ‡∏´‡∏°‡πà)
  transferLines       TransferLine[]
  consignReceiptLines ConsignReceiptLine[]
  consignReturnLines  ConsignReturnLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//===================== CONSIGNMENT CORE =====================//

enum TransferStatus {
  DRAFT
  SENT // ‡πÇ‡∏≠‡∏ô‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏ö
  PARTIAL // ‡∏£‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô
  RECEIVED // ‡∏£‡πâ‡∏≤‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏ö
  CANCELLED
}

model ConsignmentShop {
  id      Int     @id @default(autoincrement())
  code    String  @unique
  name    String
  address String?

  // ‡πÇ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô
  transfersTo Transfer[]       @relation("TransferToShop")
  // ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏° shopId ‡πÉ‡∏ô ConsignReceipt ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡∏π‡∏Å‡∏Å‡∏•‡∏±‡∏ö)
  receipts    ConsignReceipt[] @relation("ReceiptShop")
  // ‡πÉ‡∏ö‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô (‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô ConsignReturn.shop)
  returns     ConsignReturn[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Transfer {
  id           Int            @id @default(autoincrement())
  docNo        String         @unique
  fromBranchId Int
  toShopId     Int
  status       TransferStatus @default(DRAFT)
  note         String?
  docDate      DateTime       @default(now())

  // üß≠ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠
  fromBranch Branch           @relation("TransfersFromBranch", fields: [fromBranchId], references: [id])
  toShop     ConsignmentShop  @relation("TransferToShop", fields: [toShopId], references: [id])
  lines      TransferLine[]
  receipts   ConsignReceipt[]

  createdById Int?
  createdBy   User? @relation("TransferCreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TransferLine {
  id          Int     @id @default(autoincrement())
  transferId  Int
  productId   Int
  qtySent     Int
  qtyReceived Int     @default(0)
  note        String?

  transfer Transfer @relation(fields: [transferId], references: [id])
  product  Product  @relation(fields: [productId], references: [id])

  // üîÅ back-relations (‡πÉ‡∏´‡∏°‡πà)
  receiptLines ConsignReceiptLine[]
}

model ConsignReceipt {
  id         Int      @id @default(autoincrement())
  transferId Int
  docNo      String   @unique
  receivedAt DateTime @default(now())
  note       String?

  // üß≠ ‡∏ú‡∏π‡∏Å‡∏Å‡∏•‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏ù‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ ConsignmentShop.receipts ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
  shopId Int
  shop   ConsignmentShop @relation("ReceiptShop", fields: [shopId], references: [id])

  transfer Transfer             @relation(fields: [transferId], references: [id])
  lines    ConsignReceiptLine[]

  createdById Int?
  createdBy   User? @relation("ConsignReceiptCreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
}

model ConsignReceiptLine {
  id             Int @id @default(autoincrement())
  receiptId      Int
  transferLineId Int
  productId      Int
  qtyReceived    Int

  receipt      ConsignReceipt @relation(fields: [receiptId], references: [id])
  transferLine TransferLine   @relation(fields: [transferLineId], references: [id])
  product      Product        @relation(fields: [productId], references: [id])
}

enum ReturnStatus {
  DRAFT
  SENT
  CANCELLED
}

model ConsignReturn {
  id         Int          @id @default(autoincrement())
  docNo      String       @unique
  shopId     Int // ‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô
  toBranchId Int // ‡∏™‡∏≤‡∏Ç‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô
  status     ReturnStatus @default(DRAFT)
  docDate    DateTime     @default(now())
  note       String?

  shop     ConsignmentShop     @relation(fields: [shopId], references: [id])
  toBranch Branch              @relation("ReturnsToBranch", fields: [toBranchId], references: [id])
  lines    ConsignReturnLine[]

  createdById Int?
  createdBy   User? @relation("ConsignReturnCreatedBy", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ConsignReturnLine {
  id        Int @id @default(autoincrement())
  returnId  Int
  productId Int
  qty       Int

  return  ConsignReturn @relation(fields: [returnId], references: [id])
  product Product       @relation(fields: [productId], references: [id])
}
